---
import Layout from '~/layouts/PageLayout.astro';
import PropertyCard from '~/components/common/PropertyCard.astro';
import PropertyFilter from '~/components/common/PropertyFilter.astro';
import { getAllProperties } from '~/utils/sanity';

// Get all properties from Sanity
const properties = await getAllProperties();

const metadata = {
  title: 'Browse Properties - Find Your Perfect Home',
};
---

<Layout metadata={metadata}>
  <!-- Page Header -->
  <section class="px-4 pt-[160px] md:pt-[140px] 2xl:pt-[160px] pb-12 sm:px-6 mx-auto lg:px-8 max-w-7xl">
    <div class="text-center mb-8">
      <h1 class="text-4xl md:text-5xl font-bold leading-tighter tracking-tighter mb-4 font-heading">
        Browse All Properties
      </h1>
      <p class="max-w-3xl mx-auto text-xl text-muted dark:text-slate-400">
        Discover your next home from our extensive collection of residential properties
      </p>
    </div>

    <!-- Filter Component -->
    <PropertyFilter />

    <!-- Properties Grid -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
      {properties.map((property) => (
        <PropertyCard property={property} />
      ))}
    </div>

    <!-- Empty State (hidden by default, shown by JS when no results) -->
    <div id="noResults" class="hidden text-center py-16">
      <svg class="mx-auto h-24 w-24 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
      </svg>
      <h3 class="mt-4 text-xl font-semibold text-slate-900 dark:text-white">No properties found</h3>
      <p class="mt-2 text-slate-600 dark:text-slate-400">Try adjusting your filters to see more results</p>
    </div>
  </section>
</Layout>

<script>
  // Show/hide empty state based on visible properties
  function updateEmptyState() {
    const propertyCards = document.querySelectorAll('[data-property-card]');
    const visibleCards = Array.from(propertyCards).filter(card =>
      (card as HTMLElement).style.display !== 'none'
    );

    const noResults = document.getElementById('noResults');
    if (noResults) {
      if (visibleCards.length === 0) {
        noResults.classList.remove('hidden');
      } else {
        noResults.classList.add('hidden');
      }
    }
  }

  // Listen for filter changes
  const filterForm = document.getElementById('propertyFilter');
  if (filterForm) {
    filterForm.addEventListener('change', () => {
      // Wait a bit for the filter to apply
      setTimeout(updateEmptyState, 50);
    });
  }

  // Initialize on page load
  document.addEventListener('DOMContentLoaded', updateEmptyState);
  document.addEventListener('astro:page-load', updateEmptyState);
</script>
