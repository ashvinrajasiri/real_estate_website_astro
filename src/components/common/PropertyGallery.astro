---
import Image from '~/components/common/Image.astro';
import { Icon } from 'astro-icon/components';

interface Props {
  images: string[];
  title: string;
}

const { images, title } = Astro.props;
const mainImage = images[0];
const thumbnails = images.slice(1, 5); // Show up to 4 thumbnails
---

<div class="property-gallery">
  <!-- Main Image -->
  <div class="relative mb-4 rounded-lg overflow-hidden aspect-[16/10] bg-slate-200 dark:bg-slate-800 cursor-pointer hover:opacity-95 transition-opacity" data-gallery-image="0">
    <Image
      src={mainImage}
      alt={`${title} - Main view`}
      class="w-full h-full object-cover"
      width={1280}
      height={800}
      widths={[400, 768, 1024, 1280]}
      sizes="(max-width: 767px) 400px, (max-width: 1023px) 768px, 1280px"
      loading="eager"
    />

    <!-- Image Counter Badge -->
    <div class="absolute bottom-4 right-4 bg-black/70 text-white px-3 py-2 rounded-lg flex items-center space-x-2 pointer-events-none">
      <Icon name="tabler:photo" class="w-5 h-5" />
      <span class="text-sm font-medium">{images.length} Photos</span>
    </div>
  </div>

  <!-- Thumbnail Grid -->
  {thumbnails.length > 0 && (
    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
      {thumbnails.map((image, index) => (
        <div class="relative rounded-lg overflow-hidden aspect-[4/3] bg-slate-200 dark:bg-slate-800 cursor-pointer hover:opacity-75 transition-opacity" data-gallery-image={index + 1}>
          <Image
            src={image}
            alt={`${title} - View ${index + 2}`}
            class="w-full h-full object-cover"
            width={400}
            height={300}
            widths={[200, 400]}
            sizes="(max-width: 767px) 200px, 400px"
            loading="lazy"
          />
          {index === 3 && images.length > 5 && (
            <div class="absolute inset-0 bg-black/60 flex items-center justify-center text-white pointer-events-none">
              <div class="text-center">
                <Icon name="tabler:plus" class="w-8 h-8 mx-auto mb-1" />
                <span class="text-sm font-semibold">+{images.length - 5} More</span>
              </div>
            </div>
          )}
        </div>
      ))}
    </div>
  )}
</div>

<!-- Lightbox Modal -->
<div id="gallery-lightbox" class="hidden fixed inset-0 z-50 bg-black/95 flex items-center justify-center" data-lightbox>
  <button id="close-lightbox" class="absolute top-4 right-4 text-white hover:text-gray-300 transition-colors z-10" aria-label="Close gallery">
    <Icon name="tabler:x" class="w-8 h-8" />
  </button>

  <!-- Previous Button -->
  <button id="prev-image" class="absolute left-4 top-1/2 -translate-y-1/2 text-white hover:text-gray-300 transition-colors bg-black/50 rounded-full p-3" aria-label="Previous image">
    <Icon name="tabler:chevron-left" class="w-8 h-8" />
  </button>

  <!-- Next Button -->
  <button id="next-image" class="absolute right-4 top-1/2 -translate-y-1/2 text-white hover:text-gray-300 transition-colors bg-black/50 rounded-full p-3" aria-label="Next image">
    <Icon name="tabler:chevron-right" class="w-8 h-8" />
  </button>

  <!-- Image Container -->
  <div class="max-w-7xl max-h-[90vh] w-full h-full flex items-center justify-center p-4">
    <img id="lightbox-image" src="" alt="" class="max-w-full max-h-full object-contain" />
  </div>

  <!-- Image Counter -->
  <div class="absolute bottom-4 left-1/2 -translate-x-1/2 text-white bg-black/50 px-4 py-2 rounded-lg">
    <span id="current-image-number">1</span> / <span id="total-images">{images.length}</span>
  </div>
</div>

<script define:vars={{ images, title }}>
  let currentImageIndex = 0;
  let isLightboxInitialized = false;

  function initLightbox() {
    if (isLightboxInitialized) return;
    isLightboxInitialized = true;

    const lightbox = document.getElementById('gallery-lightbox');
    const lightboxImage = document.getElementById('lightbox-image');
    const currentImageNumber = document.getElementById('current-image-number');
    const closeBtn = document.getElementById('close-lightbox');
    const prevBtn = document.getElementById('prev-image');
    const nextBtn = document.getElementById('next-image');
    const galleryImages = document.querySelectorAll('[data-gallery-image]');

    function openLightbox(index) {
      currentImageIndex = index;
      updateLightboxImage();
      lightbox.classList.remove('hidden');
      document.body.style.overflow = 'hidden';
    }

    function closeLightbox() {
      lightbox.classList.add('hidden');
      document.body.style.overflow = '';
    }

    function updateLightboxImage() {
      lightboxImage.src = images[currentImageIndex];
      lightboxImage.alt = `${title} - View ${currentImageIndex + 1}`;
      currentImageNumber.textContent = currentImageIndex + 1;
    }

    function showNextImage() {
      currentImageIndex = (currentImageIndex + 1) % images.length;
      updateLightboxImage();
    }

    function showPrevImage() {
      currentImageIndex = (currentImageIndex - 1 + images.length) % images.length;
      updateLightboxImage();
    }

    // Click handlers for gallery images
    galleryImages.forEach((img) => {
      img.addEventListener('click', () => {
        const index = parseInt(img.getAttribute('data-gallery-image'));
        openLightbox(index);
      });
    });

    // Close button
    closeBtn?.addEventListener('click', closeLightbox);

    // Navigation buttons
    prevBtn?.addEventListener('click', showPrevImage);
    nextBtn?.addEventListener('click', showNextImage);

    // Click outside image to close
    lightbox?.addEventListener('click', (e) => {
      if (e.target === lightbox) {
        closeLightbox();
      }
    });

    // Keyboard navigation
    document.addEventListener('keydown', (e) => {
      if (!lightbox.classList.contains('hidden')) {
        if (e.key === 'Escape') closeLightbox();
        if (e.key === 'ArrowRight') showNextImage();
        if (e.key === 'ArrowLeft') showPrevImage();
      }
    });
  }

  // Initialize on page load
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initLightbox);
  } else {
    initLightbox();
  }

  // Re-initialize for Astro view transitions
  document.addEventListener('astro:page-load', () => {
    isLightboxInitialized = false;
    initLightbox();
  });
</script>

<style>
  .property-gallery {
    /* Additional custom styles if needed */
  }
</style>
